"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _express=_interopRequireDefault(require("express"));var _expressSession=_interopRequireDefault(require("express-session"));var _path=_interopRequireDefault(require("path"));var _morgan=_interopRequireDefault(require("morgan"));var _httpErrors=_interopRequireDefault(require("http-errors"));var _cors=_interopRequireDefault(require("cors"));var _index=_interopRequireDefault(require("./routes/index"));var _nanoid=require("nanoid");var JsonStore=require("express-session-json")(_expressSession["default"]);require("dotenv").config();var NODE_ENV=process.env.NODE_ENV;var DJPath=_path["default"].normalize(_path["default"].join(__dirname,"../../DJ/"));var buildPath=_path["default"].normalize(_path["default"].join(__dirname,"../../public/"));var assetsPath=_path["default"].normalize(_path["default"].join(__dirname,"../../public/assets/"));var readerLog=NODE_ENV==="development"?require("debug")("reader"):console.log;readerLog("Starting...");var app=(0,_express["default"])();var port=7800;var _join=function _join(){for(var _len=arguments.length,dir=new Array(_len),_key=0;_key<_len;_key++){dir[_key]=arguments[_key]}return _path["default"].join.apply(_path["default"],[__dirname].concat(dir))};app.use((0,_morgan["default"])("dev",{stream:{write:function write(msg){return readerLog(msg.trimEnd())}}}));app.use((0,_cors["default"])());app.use(_express["default"].json());app.use(_express["default"].urlencoded({extended:false}));app.use((0,_expressSession["default"])({secret:process.env.SESSION_SECRET,genid:function genid(){return(0,_nanoid.nanoid)(128)},store:new JsonStore({filename:"session.json",path:_join("../")}),resave:true,saveUninitialized:true,cookie:{path:"/",sameSite:true,maxAge:86400,secure:false,httpOnly:true}}));app.use(_express["default"]["static"](buildPath));app.use("/assets",_express["default"]["static"](assetsPath));app.use("/api/static/manga",_express["default"]["static"](DJPath,{index:false}));app.use("/api",_index["default"]);app.get("(/*)?",function(){var _ref=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee(_req,res){return _regenerator["default"].wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:res.sendFile(_path["default"].join(buildPath,"index.html"));case 1:case"end":return _context.stop();}}},_callee)}));return function(_x,_x2){return _ref.apply(this,arguments)}}());app.use(function(_req,_res,next){next((0,_httpErrors["default"])(404))});app.use(function(err,_req,res,_next){var status=err.status;res.status(status||500).json({msg:err.message,stack:err.stack})});app.listen(port,function(){return readerLog("Server listening at ".concat(port))});